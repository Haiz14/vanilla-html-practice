<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mobile Stopwatch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <style>
      /* Optional: Style for the scrollbar if needed */
      .flags-container::-webkit-scrollbar {
        width: 5px;
      }
      .flags-container::-webkit-scrollbar-track {
        background: #f1f1f1; /* Light track */
      }
      .flags-container::-webkit-scrollbar-thumb {
        background: #888; /* Light thumb */
        border-radius: 5px;
      }
      .flags-container::-webkit-scrollbar-thumb:hover {
        background: #555; /* Light thumb hover */
      }
      /* Ensure consistent width for the timer's ms part */
      .ms-digits {
        display: inline-block; /* Helps stabilize layout */
        min-width: 4ch; /* Adjust if needed based on font */
        text-align: left;
      }
      /* Minor style tweak for header alignment */
      thead th {
        white-space: nowrap;
      }
      /* Quick flag zone */
      .quick-flag-zone {
        position: fixed;
        top: 0;
        right: 0;
        width: 50%;
        height: 100%;
        z-index: 10;
      }
      /* Toggle switch styles */
      .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #10b981;
      }
      input:checked + .slider:before {
        transform: translateX(26px);
      }
      @keyframes ripple {
        0% {
          transform: scale(0.5);
          opacity: 0.5;
        }
        100% {
          transform: scale(2);
          opacity: 0;
        }
      }
      /* Modal styles */
    </style>
  </head>
  <body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div class="h-screen flex flex-col" x-data="stopwatch">
      <!-- Quick flag zone (clickable area) -->
      <div
        id="quickFlagZone"
        class="quick-flag-zone"
        x-show="quickFlagEnabled && running"
        @click="quickFlag($event)"
      ></div>

      <!-- Controls at top -->
      <div
        class="absolute top-4 left-4 right-4 flex justify-between items-center z-20"
      >
        <!-- Interval controls -->
        <div
          class="flex items-center space-x-2 bg-gray-200/20 dark:bg-gray-700/20 px-3 py-2 rounded-full shadow-md"
        >
          <button
            @click="resetInterval"
            class="text-gray-700 dark:text-gray-300 font-bold"
          >
            r
          </button>
          <button
            @click="decreaseInterval"
            class="text-gray-700 dark:text-gray-300 font-bold"
          >
            -
          </button>
          <span
            @click="showIntervalModal"
            class="text-xs font-medium cursor-pointer px-2"
            x-text="interval > 0 ? interval + 's' : 'Interval'"
          >
          </span>
          <button
            @click="increaseInterval(1)"
            class="text-gray-700 dark:text-gray-300 font-bold"
          >
            +
          </button>
          <button
            @click="increaseInterval(5)"
            class="text-gray-700 dark:text-gray-300 font-bold"
          >
            5+
          </button>
          <button
            @click="increaseInterval(25)"
            class="text-gray-700 dark:text-gray-300 font-bold"
          >
            25+
          </button>
        </div>

        <!-- Quick flag toggle -->
        <div
          class="flex items-center space-x-2 bg-gray-200/20 dark:bg-gray-700/20 px-3 py-2 rounded-full shadow-md"
        >
          <span class="text-xs font-medium">Quick Flag</span>
          <label class="switch">
            <input type="checkbox" x-model="quickFlagEnabled" />
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <!-- Interval modal -->
      <div
        id="intervalModal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
        x-show="showModal"
        x-transition
        @click.away="showModal = false"
        style="display: none"
      >
        <div
          class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-xs p-6"
          @click.stop
        >
          <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">
            Set Interval (seconds)
          </h3>
          <input
            type="number"
            class="w-full px-4 py-3 mb-2 text-center text-lg border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            x-model="newInterval"
            min="0"
            step="1"
            @keyup.enter="setIntervalValue"
            placeholder="Enter seconds"
          />
          <p id="intervalError" class="hidden text-red-500 text-sm mt-1">
            Please enter a positive number
          </p>
          <div class="flex justify-end space-x-3 mt-6">
            <button
              @click="showModal = false"
              class="px-4 py-2 text-sm font-medium rounded-md bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-200"
            >
              Cancel
            </button>
            <button
              @click="setIntervalValue"
              class="px-4 py-2 text-sm font-medium rounded-md bg-blue-600 hover:bg-blue-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            >
              Set
            </button>
          </div>
        </div>
      </div>

      <!-- Error modal -->
      <div
        id="errorModal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
        x-show="showErrorModal"
        x-transition
        @click.away="showErrorModal = false"
        style="display: none"
      >
        <div
          class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-xs p-6"
          @click.stop
        >
          <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">
            Invalid Interval
          </h3>
          <p class="mb-6 text-gray-700 dark:text-gray-300">
            Interval must be a positive number.
          </p>
          <div class="flex justify-end">
            <button
              @click="showErrorModal = false"
              class="px-4 py-2 text-sm font-medium rounded-md bg-blue-600 hover:bg-blue-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            >
              OK
            </button>
          </div>
        </div>
      </div>
      <div class="text-center py-16 md:py-12">
        <span
          id="timerDisplay"
          class="text-6xl md:text-7xl font-mono text-gray-800 dark:text-gray-200"
          x-html="formattedTime"
        >
          00:00:00.<span class="text-4xl md:text-5xl ms-digits">000</span>
        </span>
      </div>

      <div class="flex-grow overflow-y-auto px-4 pb-8 flags-container">
        <table
          class="w-full text-sm text-left text-gray-600 dark:text-gray-400"
        >
          <thead
            class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-200 dark:bg-gray-700 sticky top-0 z-10"
          >
            <tr>
              <th scope="col" class="px-3 py-3 rounded-tl-lg">Flag #</th>
              <th scope="col" class="px-3 py-3">Time</th>
              <th scope="col" class="px-3 py-3 rounded-tr-lg">Split</th>
            </tr>
          </thead>
          <tbody id="flagsTableBody">
            <template x-for="(flag, index) in flags" :key="index">
              <tr
                :class="index % 2 === 0 ? 'bg-white dark:bg-gray-800' : 'bg-gray-50 dark:bg-gray-700'"
                class="border-b hover:bg-gray-100 dark:hover:bg-gray-600"
              >
                <td
                  class="px-6 py-3 font-medium text-gray-900 dark:text-white"
                  x-text="flag.number"
                ></td>
                <td
                  class="px-6 py-3 font-mono"
                  x-html="formatTimeForTableWithoutHours(flag.totalTime)"
                ></td>
                <td
                  class="px-3 py-3 font-mono"
                  x-html="formatTimeForTableWithoutHours(flag.splitTime)"
                ></td>
              </tr>
            </template>
          </tbody>
        </table>
        <p
          id="flagsPlaceholder"
          class="text-center text-gray-400 dark:text-gray-500 italic mt-6"
          x-show="flags.length === 0"
        >
          No flags recorded yet.
        </p>
      </div>

      <div
        class="flex w-full sticky bottom-0 bg-gray-100 dark:bg-gray-800 shadow-inner pt-1"
      >
        <button
          id="startPauseButton"
          @click="startPause"
          :class="running ? 'bg-blue-500 hover:bg-blue-600' : 'bg-yellow-500 hover:bg-yellow-600'"
          class="flex-1 py-10 text-xl font-semibold text-white focus:outline-none transition duration-150 ease-in-out"
        >
          <span
            x-text="running ? 'Pause' : (elapsedTime > 0 ? 'Resume' : 'Start')"
          ></span>
        </button>
        <button
          id="resetButton"
          @click="reset"
          :disabled="elapsedTime === 0"
          :class="{'opacity-50 cursor-not-allowed': elapsedTime === 0}"
          class="flex-1 py-16 text-xl font-semibold text-white bg-red-500 hover:bg-red-600 focus:outline-none transition duration-150 ease-in-out"
        >
          Reset
        </button>
        <button
          id="flagButton"
          @click="flag"
          :disabled="!running"
          :class="{'opacity-50 cursor-not-allowed': !running}"
          class="flex-1 py-16 text-xl font-semibold text-white bg-green-500 hover:bg-green-600 focus:outline-none transition duration-150 ease-in-out"
        >
          Flag
        </button>
      </div>
    </div>

    <script>
      document.addEventListener("alpine:init", () => {
        Alpine.data("stopwatch", () => ({
          startTime: 0,
          elapsedTime: 0,
          timerInterval: null,
          running: false,
          flagCounter: 0,
          lastFlagTime: 0,
          quickFlagEnabled: false,
          flags: [],
          formattedTime:
            '00:00:00.<span class="text-4xl md:text-5xl ms-digits">000</span>',
          interval: 0,
          intervalTimer: null,
          showModal: false,
          showErrorModal: false,
          newInterval: 0,
          audioContext: null, // For Web Audio API
          beepFrequency: 440, // Pitch of the beep (440Hz = A4 note)

          init() {
            // Initialize timer display
            this.updateTimer();

            // Check for vibration API support
            this.vibrationSupported = "vibrate" in navigator;
          },

          formatTime(milliseconds, isSplit = false) {
            if (milliseconds < 0) milliseconds = 0;
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const ms = Math.floor(milliseconds % 1000);

            const formattedMs = ms.toString().padStart(3, "0");
            const mainTime = `${hours.toString().padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

            return `${mainTime}.<span class="text-4xl md:text-5xl ms-digits">${formattedMs}</span>`;
          },

          formatTimeForTableWithoutHours(milliseconds) {
            if (milliseconds < 0) milliseconds = 0;
            const totalSeconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const ms = Math.floor(milliseconds % 1000);

            const formattedMs = ms.toString().padStart(3, "0");
            const mainTime = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

            return `${mainTime}.<span class="text-xs">${formattedMs}</span>`;
          },

          updateTimer() {
            if (this.running) {
              const currentTime = Date.now();
              const totalElapsedTime =
                this.elapsedTime + (currentTime - this.startTime);
              this.formattedTime = this.formatTime(totalElapsedTime);
            } else {
              this.formattedTime = this.formatTime(this.elapsedTime);
            }

            // Set up the next update
            if (this.running) {
              requestAnimationFrame(this.updateTimer.bind(this));
            }
          },

          startPause() {
            if (this.running) {
              // Pause timer
              this.elapsedTime += Date.now() - this.startTime;
              this.running = false;
              cancelAnimationFrame(this.timerInterval);
              this.clearIntervalTimer();
            } else {
              // Start or resume timer
              this.startTime = Date.now();
              this.running = true;
              requestAnimationFrame(this.updateTimer.bind(this));
              this.startIntervalTimer();
            }
          },

          reset() {
            cancelAnimationFrame(this.timerInterval);
            this.clearIntervalTimer();
            this.running = false;
            this.elapsedTime = 0;
            this.startTime = 0;
            this.flagCounter = 0;
            this.lastFlagTime = 0;
            this.flags = [];
            this.formattedTime =
              '00:00:00.<span class="text-4xl md:text-5xl ms-digits">000</span>';
          },

            playBeep(configs = [{}]) {
  try {
    // Lazy initialize audio context
    if (!this.audioContext) {
      this.audioContext = new (window.AudioContext ||
        window.webkitAudioContext)();
    }

    const now = this.audioContext.currentTime;
    let currentTime = now;
    
    // Process each config object in the array
    configs.forEach((config, index) => {
      const {
        duration = 0.5,       // duration in seconds
        volume = 0.8,         // volume (0.0-1.0)
        waveform = "sine",    // waveform type
        frequency = this.beepFrequency,  // frequency in Hz
        onEnded = null        // optional callback for last beep
      } = config;

      const oscillator = this.audioContext.createOscillator();
      const gainNode = this.audioContext.createGain();

      oscillator.type = waveform;
      oscillator.frequency.value = frequency;
      gainNode.gain.value = volume;

      oscillator.connect(gainNode);
      gainNode.connect(this.audioContext.destination);

      oscillator.start(currentTime);
      oscillator.stop(currentTime + duration);
      
      currentTime += duration;

      // Cleanup
      oscillator.onended = () => {
        oscillator.disconnect();
        gainNode.disconnect();
        if (index === configs.length - 1 && onEnded) onEnded();
      };
    });
  } catch (error) {
    console.warn("Audio playback failed:", error);
    if (this.vibrationSupported) navigator.vibrate(200);
  }
},
          flag() {
            if (!this.running) return;

            const currentTime = Date.now();
            const currentTotalFlagTime =
              this.elapsedTime + (currentTime - this.startTime);
            const timeDifference = currentTotalFlagTime - this.lastFlagTime;

            this.flagCounter++;

            // Add flag to the beginning of the array (for reverse chronological display)
            this.flags.unshift({
              number: this.flagCounter,
              totalTime: currentTotalFlagTime,
              splitTime: timeDifference,
            });

            // Update the last flag time
            this.lastFlagTime = currentTotalFlagTime;
          },

          quickFlag(event) {
            if (this.quickFlagEnabled && this.running) {
              this.flag();

              // Create ripple effect
              const ripple = document.createElement("div");
              ripple.classList.add(
                "absolute",
                "bg-green-400",
                "opacity-50",
                "rounded-full",
              );
              ripple.style.width = "60px";
              ripple.style.height = "60px";
              ripple.style.left = event.clientX - 30 + "px";
              ripple.style.top = event.clientY - 30 + "px";
              ripple.style.animation = "ripple 0.6s linear";
              document.body.appendChild(ripple);

              setTimeout(() => {
                document.body.removeChild(ripple);
              }, 600);

              event.preventDefault();
              event.stopPropagation();
            }
          },

          // Interval methods
          increaseInterval(no) {
            this.newInterval = this.interval + no;
            this.setIntervalValue();
          },

          resetInterval() {
            if (this.interval > 0) {
              this.newInterval = 0;
              this.setIntervalValue();
            }
          },
          decreaseInterval() {
            if (this.interval > 0) {
              this.newInterval = this.interval - 1;
              this.setIntervalValue();
            }
          },

          showIntervalModal() {
            this.newInterval = this.interval;
            this.showModal = true;
          },

          setIntervalValue() {
            const value = parseInt(this.newInterval);
            if (isNaN(value) || value < 0) {
              this.showErrorModal = true;
              return;
            }

            this.interval = value;
            this.showModal = false;

            // Restart interval timer if running
            if (this.running) {
              this.clearIntervalTimer();
              this.startIntervalTimer();
            }
          },

          startIntervalTimer() {
            if (this.interval > 0 && this.running) {
              this.clearIntervalTimer();
              this.intervalTimer = setInterval(() => {
                // this.flag();
                  this.playBeep([
                      { waveform: "square", frequency: 392, duration: 0.15, volume: 0.6 }, // G4
  { waveform: "square", frequency: 349.23, duration: 0.15, volume: 0.6 }, // F4
                  ]);
  
                if (this.vibrationSupported) {
                  // Vibrate for 200ms
                  navigator.vibrate(200);
                }
              }, this.interval * 1000);
            }
          },

          clearIntervalTimer() {
            if (this.intervalTimer) {
              clearInterval(this.intervalTimer);
              this.intervalTimer = null;
            }
          },
        }));
      });
    </script>
  </body>
</html>
